<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√úbergabeprotokoll v2</title>
    
    <!-- jsPDF and jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: #8b0000;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: white;
            text-decoration: none;
            opacity: 0.9;
        }
        
        .back-link:hover {
            opacity: 1;
        }
        
        .content {
            padding: 40px;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        .instructions h2 {
            color: #1976d2;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .info-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f5f5f5;
            padding: 15px 20px;
            border-bottom: 2px solid #8b0000;
        }
        
        .section-title {
            font-size: 20px;
            color: #8b0000;
            font-weight: 600;
        }
        
        .section-content {
            padding: 20px;
        }
        
        .item {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            transition: all 0.3s;
            background: white;
            font-size: 14px;
        }
        
        .checkbox-label:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .checkbox-label.checked {
            border-color: #8b0000;
            background: #fff5f5;
        }
        
        input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .remarks {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 10px;
        }
        
        .remarks:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .photo-upload-section {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 2px dashed #ddd;
        }
        
        .photo-upload-label {
            display: block;
            text-align: center;
            padding: 20px;
            background: white;
            border: 2px dashed #667eea;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload-label:hover {
            background: #f8f9ff;
            border-color: #8b0000;
        }
        
        .photo-upload-label.has-files {
            border-color: #4caf50;
            background: #f1f8f4;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .photo-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 5px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-preview .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        .signature-section {
            background: #f9f9f9;
            padding: 30px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .signature-section h3 {
            color: #8b0000;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .signature-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .signature-field {
            display: flex;
            flex-direction: column;
        }
        
        .signature-field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .signature-field input[type="text"],
        .signature-field input[type="email"],
        .signature-field input[type="date"] {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .signature-canvas-container {
            border: 2px solid #ddd;
            border-radius: 5px;
            background: white;
            margin-bottom: 20px;
        }
        
        .signature-canvas-label {
            background: #f5f5f5;
            padding: 10px 15px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #ddd;
        }
        
        .signature-canvas {
            display: block;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            touch-action: none;
        }
        
        .signature-buttons {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        
        .clear-signature {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-signature:hover {
            background: #d32f2f;
        }
        
        .submit-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .submit-btn {
            background: #8b0000;
            color: white;
            padding: 15px 50px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            max-width: 400px;
            margin: 10px auto;
            display: block;
        }
        
        .submit-btn:hover:not(:disabled) {
            background: #660000;
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .progress-indicator {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 5px;
            border-left: 4px solid #ff9800;
        }
        
        .success-message {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .signature-canvas {
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-link">‚Üê Zur√ºck zur Sprachauswahl</a>
            <h1>üè† √úbergabeprotokoll</h1>
            <p>Dokumentation des Zustands bei √úbergabe</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h2>üìã Anleitung</h2>
                <ol>
                    <li>F√ºllen Sie alle Felder aus</li>
                    <li>Machen Sie Fotos (werden automatisch komprimiert)</li>
                    <li>Unterschreiben Sie digital mit dem Finger</li>
                    <li>Klicken Sie auf "PDF erstellen & herunterladen"</li>
                    <li>Senden Sie das PDF per E-Mail an alle Beteiligten</li>
                </ol>
            </div>

            <div class="info-box">
                <strong>‚ú® Neu:</strong> Digitale Unterschrift mit Finger ‚Ä¢ Auto-Komprimierung von Fotos ‚Ä¢ PDF-Download mit allen Daten
            </div>

            <form id="handoverForm">
                
                <!-- OBJEKTDATEN -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üè¢ Objektdaten</h2>
                    </div>
                    <div class="section-content">
                        <div class="item">
                            <div class="item-name">Adresse *</div>
                            <textarea class="remarks" id="property_address" placeholder="Stra√üe, Hausnummer, PLZ, Ort&#10;z.B. Engadinerstr. 36, 81475 M√ºnchen" required style="min-height: 80px;"></textarea>
                        </div>

                        <div class="item">
                            <div class="item-name">Art des Objekts *</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="property_type" value="Ganze Wohnung" onchange="updateRadio(this); toggleRoomNumber(false)" required>
                                    <span>Ganze Wohnung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="property_type" value="Zimmer" onchange="updateRadio(this); toggleRoomNumber(true)">
                                    <span>Zimmer</span>
                                </label>
                            </div>
                            <div id="room_number_field" style="display: none; margin-top: 15px;">
                                <textarea class="remarks" id="room_number" placeholder="Zimmernummer / Bezeichnung&#10;z.B. Zimmer 1, Zimmer 2A, etc." style="min-height: 60px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ZIMMER -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üö™ Zimmer</h2>
                    </div>
                    <div class="section-content">
                        <div class="item">
                            <div class="item-name">W√§nde</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="room_walls" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_walls" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_walls" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="room_walls_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_room_walls">
                                    üì∑ Fotos von W√§nden hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'room_walls')">
                                </label>
                                <div class="photo-preview-container" id="preview_room_walls"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Boden</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="room_floor" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_floor" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_floor" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="room_floor_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_room_floor">
                                    üì∑ Fotos vom Boden hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'room_floor')">
                                </label>
                                <div class="photo-preview-container" id="preview_room_floor"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Fenster</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="room_windows" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_windows" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_windows" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="room_windows_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_room_windows">
                                    üì∑ Fotos von Fenstern hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'room_windows')">
                                </label>
                                <div class="photo-preview-container" id="preview_room_windows"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Sauberkeit</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="room_cleanliness" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_cleanliness" value="Leicht verschmutzt" onchange="updateRadio(this)">
                                    <span>Leicht verschmutzt</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="room_cleanliness" value="Stark verschmutzt" onchange="updateRadio(this)">
                                    <span>Stark verschmutzt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="room_cleanliness_remarks" placeholder="Bemerkungen..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- M√ñBEL -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üõãÔ∏è M√∂bel</h2>
                    </div>
                    <div class="section-content">
                        <div class="item">
                            <div class="item-name">Bett</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_bed" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_bed" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_bed" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_bed" value="Fehlt" onchange="updateRadio(this)">
                                    <span>Fehlt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="furniture_bed_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_furniture_bed">
                                    üì∑ Fotos vom Bett hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'furniture_bed')">
                                </label>
                                <div class="photo-preview-container" id="preview_furniture_bed"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Schreibtisch</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_desk" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_desk" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_desk" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_desk" value="Fehlt" onchange="updateRadio(this)">
                                    <span>Fehlt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="furniture_desk_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_furniture_desk">
                                    üì∑ Fotos vom Schreibtisch hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'furniture_desk')">
                                </label>
                                <div class="photo-preview-container" id="preview_furniture_desk"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Stuhl</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_chair" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_chair" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_chair" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_chair" value="Fehlt" onchange="updateRadio(this)">
                                    <span>Fehlt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="furniture_chair_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_furniture_chair">
                                    üì∑ Fotos vom Stuhl hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'furniture_chair')">
                                </label>
                                <div class="photo-preview-container" id="preview_furniture_chair"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Kleiderschrank</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_wardrobe" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_wardrobe" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_wardrobe" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="furniture_wardrobe" value="Fehlt" onchange="updateRadio(this)">
                                    <span>Fehlt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="furniture_wardrobe_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_furniture_wardrobe">
                                    üì∑ Fotos vom Schrank hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'furniture_wardrobe')">
                                </label>
                                <div class="photo-preview-container" id="preview_furniture_wardrobe"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GEMEINSCHAFTSBEREICHE -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üë• Gemeinschaftsbereiche</h2>
                    </div>
                    <div class="section-content">
                        <div class="item">
                            <div class="item-name">K√ºche</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="common_kitchen" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="common_kitchen" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="common_kitchen" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="common_kitchen_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_common_kitchen">
                                    üì∑ Fotos von K√ºche hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'common_kitchen')">
                                </label>
                                <div class="photo-preview-container" id="preview_common_kitchen"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Badezimmer</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="common_bathroom" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="common_bathroom" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="common_bathroom" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="common_bathroom_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_common_bathroom">
                                    üì∑ Fotos vom Bad hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'common_bathroom')">
                                </label>
                                <div class="photo-preview-container" id="preview_common_bathroom"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Flur</div>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="common_hallway" value="Ausgezeichnet" onchange="updateRadio(this)">
                                    <span>Ausgezeichnet</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="common_hallway" value="Leichte Abnutzung" onchange="updateRadio(this)">
                                    <span>Leichte Abnutzung</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="common_hallway" value="Besch√§digt" onchange="updateRadio(this)">
                                    <span>Besch√§digt</span>
                                </label>
                            </div>
                            <textarea class="remarks" id="common_hallway_remarks" placeholder="Bemerkungen..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_common_hallway">
                                    üì∑ Fotos vom Flur hochladen
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'common_hallway')">
                                </label>
                                <div class="photo-preview-container" id="preview_common_hallway"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SCHL√úSSEL -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üîë Schl√ºssel</h2>
                    </div>
                    <div class="section-content">
                        <div class="item">
                            <div class="item-name">Anzahl √ºbergebener Schl√ºssel</div>
                            <textarea class="remarks" id="keys_details" placeholder="Z.B. 2x Wohnungsschl√ºssel, 1x Briefkastenschl√ºssel, 1x Haust√ºrschl√ºssel..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_keys">
                                    üì∑ Foto von allen Schl√ºsseln
                                    <input type="file" accept="image/*" multiple onchange="handlePhotoUpload(this, 'keys')">
                                </label>
                                <div class="photo-preview-container" id="preview_keys"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Z√ÑHLERST√ÑNDE -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">‚ö° Z√§hlerst√§nde</h2>
                    </div>
                    <div class="section-content">
                        <div class="item">
                            <div class="item-name">Stromz√§hler</div>
                            <textarea class="remarks" id="meter_electricity" placeholder="Z√§hlerstand eingeben..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_meter_electricity">
                                    üì∑ Foto vom Stromz√§hler
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(this, 'meter_electricity')">
                                </label>
                                <div class="photo-preview-container" id="preview_meter_electricity"></div>
                            </div>
                        </div>

                        <div class="item">
                            <div class="item-name">Wasserz√§hler</div>
                            <textarea class="remarks" id="meter_water" placeholder="Warmwasser / Kaltwasser Z√§hlerst√§nde..."></textarea>
                            <div class="photo-upload-section">
                                <label class="photo-upload-label" id="label_meter_water">
                                    üì∑ Foto vom Wasserz√§hler
                                    <input type="file" accept="image/*" onchange="handlePhotoUpload(this, 'meter_water')">
                                </label>
                                <div class="photo-preview-container" id="preview_meter_water"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- E-MAIL & UNTERSCHRIFTEN -->
                <div class="signature-section">
                    <h3>üìß E-Mail-Adressen f√ºr Versand</h3>
                    <div class="info-box">
                        Bitte tragen Sie alle E-Mail-Adressen ein. Das PDF soll an diese Adressen gesendet werden.
                    </div>
                    
                    <div class="signature-group">
                        <div class="signature-field">
                            <label>E-Mail Ausziehender Mieter: *</label>
                            <input type="email" id="email_outgoing" required placeholder="mieter.alt@example.com">
                        </div>
                        <div class="signature-field">
                            <label>E-Mail Einziehender Mieter: *</label>
                            <input type="email" id="email_incoming" required placeholder="mieter.neu@example.com">
                        </div>
                        <div class="signature-field">
                            <label>E-Mail Vermieter:</label>
                            <input type="email" id="email_landlord" value="chriskranz88@googlemail.com" placeholder="vermieter@example.com">
                        </div>
                    </div>

                    <h3>‚úçÔ∏è Digitale Unterschriften</h3>
                    <div class="info-box">
                        Bitte mit dem Finger auf dem grauen Feld unterschreiben. Funktioniert am besten auf dem Smartphone!
                    </div>
                    
                    <div class="signature-canvas-container">
                        <div class="signature-canvas-label">Unterschrift Ausziehender Mieter</div>
                        <canvas id="signature_outgoing" class="signature-canvas"></canvas>
                        <div class="signature-buttons">
                            <button type="button" class="clear-signature" onclick="clearSignature('signature_outgoing')">L√∂schen</button>
                            <input type="text" placeholder="Name" id="name_outgoing" required style="flex: 1; margin-left: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <div class="signature-canvas-container">
                        <div class="signature-canvas-label">Unterschrift Einziehender Mieter</div>
                        <canvas id="signature_incoming" class="signature-canvas"></canvas>
                        <div class="signature-buttons">
                            <button type="button" class="clear-signature" onclick="clearSignature('signature_incoming')">L√∂schen</button>
                            <input type="text" placeholder="Name" id="name_incoming" required style="flex: 1; margin-left: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <div class="signature-field">
                        <label>Datum der √úbergabe: *</label>
                        <input type="date" id="handover_date" required>
                    </div>
                </div>

                <!-- SUBMIT -->
                <div class="submit-section">
                    <button type="button" class="submit-btn" id="generatePdfBtn" onclick="generateAndDownloadPDF()">
                        üìÑ PDF erstellen & herunterladen
                    </button>
                    <div class="progress-indicator" id="progressIndicator">
                        ‚è≥ PDF wird erstellt... Bitte warten...
                    </div>
                    <div class="success-message" id="successMessage">
                        ‚úÖ PDF erfolgreich erstellt und heruntergeladen!<br>
                        <strong>N√§chster Schritt:</strong> Senden Sie das PDF per E-Mail an:<br>
                        <span id="emailList"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // GOOGLE APPS SCRIPT INTEGRATION
        // WICHTIG: Ersetze diese URL mit deiner eigenen Web-App-URL nach dem Deployment!
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/library/d/1_rF8YxA0QKhe7LwdS6tfecIpqIgVjBRRh-veyCty3oEKz_VADjh-04Uc/2';
        // Beispiel: 'https://script.google.com/macros/s/AKfycbxXXXXXXXXXXXXXXXXXXX/exec'
        
        // Store all data globally
        const formData = {
            photos: {},
            signatures: {}
        };
        
        // Signature Pad Setup
        function initializeSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 150;
            
            // Fill with white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }
            
            function startDrawing(e) {
                isDrawing = true;
                const coords = getCoordinates(e);
                lastX = coords.x;
                lastY = coords.y;
                e.preventDefault();
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const coords = getCoordinates(e);
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(coords.x, coords.y);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                lastX = coords.x;
                lastY = coords.y;
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);
        }
        
        function clearSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Initialize signature pads on load
        window.addEventListener('load', function() {
            initializeSignaturePad('signature_outgoing');
            initializeSignaturePad('signature_incoming');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('handover_date').value = today;
        });
        
        // Photo handling with compression
        function compressImage(file, maxSizeMB = 1) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Resize if too large
                        const maxDimension = 1600;
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = (height / width) * maxDimension;
                                width = maxDimension;
                            } else {
                                width = (width / height) * maxDimension;
                                height = maxDimension;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(dataUrl);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function handlePhotoUpload(input, category) {
            const files = Array.from(input.files);
            const label = document.getElementById(`label_${category}`);
            const previewContainer = document.getElementById(`preview_${category}`);
            
            if (files.length === 0) return;
            
            label.classList.add('has-files');
            label.innerHTML = `‚è≥ ${files.length} Foto(s) werden komprimiert...`;
            
            // Compress photos
            const compressedDataUrls = [];
            for (const file of files) {
                const compressed = await compressImage(file);
                compressedDataUrls.push(compressed);
            }
            
            formData.photos[category] = compressedDataUrls;
            label.innerHTML = `‚úÖ ${compressedDataUrls.length} Foto(s) komprimiert`;
            
            // Show previews
            previewContainer.innerHTML = '';
            compressedDataUrls.forEach((dataUrl, index) => {
                const preview = document.createElement('div');
                preview.className = 'photo-preview';
                preview.innerHTML = `
                    <img src="${dataUrl}" alt="Photo ${index + 1}">
                    <button type="button" class="remove-photo" onclick="removePhoto('${category}', ${index})">√ó</button>
                `;
                previewContainer.appendChild(preview);
            });
        }
        
        function removePhoto(category, index) {
            formData.photos[category].splice(index, 1);
            
            // Update preview
            const previewContainer = document.getElementById(`preview_${category}`);
            const label = document.getElementById(`label_${category}`);
            
            if (formData.photos[category].length === 0) {
                delete formData.photos[category];
                label.classList.remove('has-files');
                label.innerHTML = `üì∑ Fotos hochladen`;
                previewContainer.innerHTML = '';
            } else {
                label.innerHTML = `‚úÖ ${formData.photos[category].length} Foto(s) komprimiert`;
                previewContainer.innerHTML = '';
                formData.photos[category].forEach((dataUrl, idx) => {
                    const preview = document.createElement('div');
                    preview.className = 'photo-preview';
                    preview.innerHTML = `
                        <img src="${dataUrl}" alt="Photo ${idx + 1}">
                        <button type="button" class="remove-photo" onclick="removePhoto('${category}', ${idx})">√ó</button>
                    `;
                    previewContainer.appendChild(preview);
                });
            }
        }
        
        function toggleRoomNumber(show) {
            const field = document.getElementById('room_number_field');
            const input = document.getElementById('room_number');
            if (show) {
                field.style.display = 'block';
                input.required = true;
            } else {
                field.style.display = 'none';
                input.required = false;
                input.value = '';
            }
        }
        
        function updateRadio(radio) {
            const name = radio.name;
            const allRadios = document.querySelectorAll(`input[name="${name}"]`);
            allRadios.forEach(r => {
                if (r === radio && r.checked) {
                    r.parentElement.classList.add('checked');
                } else {
                    r.parentElement.classList.remove('checked');
                }
            });
        }
        
        function getFormValue(id) {
            const element = document.getElementById(id);
            if (!element) return '';
            if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                return element.value || '';
            }
            return '';
        }
        
        function getRadioValue(name) {
            const radio = document.querySelector(`input[name="${name}"]:checked`);
            return radio ? radio.value : 'Nicht angegeben';
        }
        
        async function generateAndDownloadPDF() {
            const btn = document.getElementById('generatePdfBtn');
            const progress = document.getElementById('progressIndicator');
            const success = document.getElementById('successMessage');
            
            // Validate
            const requiredFields = ['property_address', 'name_outgoing', 'name_incoming', 'handover_date', 
                                   'email_outgoing', 'email_incoming'];
            for (const fieldId of requiredFields) {
                const element = document.getElementById(fieldId);
                if (!element.value) {
                    alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                    element.focus();
                    return;
                }
            }
            
            // Check signatures
            const sigOutgoing = document.getElementById('signature_outgoing');
            const sigIncoming = document.getElementById('signature_incoming');
            const ctxOut = sigOutgoing.getContext('2d');
            const ctxIn = sigIncoming.getContext('2d');
            
            // Check if canvas is blank (simple check)
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = sigOutgoing.width;
            blankCanvas.height = sigOutgoing.height;
            const blankCtx = blankCanvas.getContext('2d');
            blankCtx.fillStyle = '#ffffff';
            blankCtx.fillRect(0, 0, blankCanvas.width, blankCanvas.height);
            
            if (sigOutgoing.toDataURL() === blankCanvas.toDataURL() || 
                sigIncoming.toDataURL() === blankCanvas.toDataURL()) {
                alert('Bitte unterschreiben Sie beide Felder!');
                return;
            }
            
            btn.disabled = true;
            progress.style.display = 'block';
            success.style.display = 'none';
            
            try {
                // Get jsPDF from window (loaded from CDN)
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                const contentWidth = doc.internal.pageSize.width - 2 * margin;
                
                // Helper function to add new page if needed
                function checkAddPage(neededSpace = 20) {
                    if (yPosition + neededSpace > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 20;
                        return true;
                    }
                    return false;
                }
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(139, 0, 0);
                doc.text('√úbergabeprotokoll', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Dokumentation des Zustands bei √úbergabe', margin, yPosition);
                yPosition += 15;
                
                // Section: Objektdaten
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('Objektdaten', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Adresse: ${getFormValue('property_address')}`, margin, yPosition);
                yPosition += 6;
                doc.text(`Art: ${getRadioValue('property_type')}`, margin, yPosition);
                yPosition += 6;
                const roomNumber = getFormValue('room_number');
                if (roomNumber) {
                    doc.text(`Zimmer: ${roomNumber}`, margin, yPosition);
                    yPosition += 6;
                }
                yPosition += 5;
                
                // Section: Zimmer
                checkAddPage(30);
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('Zimmer', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const roomItems = [
                    { label: 'W√§nde', name: 'room_walls', remarks: 'room_walls_remarks' },
                    { label: 'Boden', name: 'room_floor', remarks: 'room_floor_remarks' },
                    { label: 'Fenster', name: 'room_windows', remarks: 'room_windows_remarks' },
                    { label: 'Sauberkeit', name: 'room_cleanliness', remarks: 'room_cleanliness_remarks' }
                ];
                
                for (const item of roomItems) {
                    checkAddPage(15);
                    doc.text(`‚Ä¢ ${item.label}: ${getRadioValue(item.name)}`, margin + 2, yPosition);
                    yPosition += 5;
                    const remarks = getFormValue(item.remarks);
                    if (remarks) {
                        doc.setFontSize(9);
                        doc.setTextColor(80, 80, 80);
                        const lines = doc.splitTextToSize(`  Bemerkung: ${remarks}`, contentWidth - 5);
                        doc.text(lines, margin + 2, yPosition);
                        yPosition += lines.length * 4;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    // Add photos if available
                    if (formData.photos[item.name] && formData.photos[item.name].length > 0) {
                        yPosition += 2;
                        for (const photoData of formData.photos[item.name]) {
                            checkAddPage(60);
                            try {
                                doc.addImage(photoData, 'JPEG', margin + 2, yPosition, 50, 50);
                                yPosition += 52;
                            } catch (e) {
                                console.error('Error adding image:', e);
                            }
                        }
                    }
                    yPosition += 3;
                }
                
                yPosition += 5;
                
                // Section: M√∂bel
                checkAddPage(30);
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('M√∂bel', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const furnitureItems = [
                    { label: 'Bett', name: 'furniture_bed', remarks: 'furniture_bed_remarks' },
                    { label: 'Schreibtisch', name: 'furniture_desk', remarks: 'furniture_desk_remarks' },
                    { label: 'Stuhl', name: 'furniture_chair', remarks: 'furniture_chair_remarks' },
                    { label: 'Kleiderschrank', name: 'furniture_wardrobe', remarks: 'furniture_wardrobe_remarks' }
                ];
                
                for (const item of furnitureItems) {
                    checkAddPage(15);
                    doc.text(`‚Ä¢ ${item.label}: ${getRadioValue(item.name)}`, margin + 2, yPosition);
                    yPosition += 5;
                    const remarks = getFormValue(item.remarks);
                    if (remarks) {
                        doc.setFontSize(9);
                        doc.setTextColor(80, 80, 80);
                        const lines = doc.splitTextToSize(`  Bemerkung: ${remarks}`, contentWidth - 5);
                        doc.text(lines, margin + 2, yPosition);
                        yPosition += lines.length * 4;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    if (formData.photos[item.name] && formData.photos[item.name].length > 0) {
                        yPosition += 2;
                        for (const photoData of formData.photos[item.name]) {
                            checkAddPage(60);
                            try {
                                doc.addImage(photoData, 'JPEG', margin + 2, yPosition, 50, 50);
                                yPosition += 52;
                            } catch (e) {
                                console.error('Error adding image:', e);
                            }
                        }
                    }
                    yPosition += 3;
                }
                
                yPosition += 5;
                
                // Section: Gemeinschaftsbereiche
                checkAddPage(30);
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('Gemeinschaftsbereiche', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const commonItems = [
                    { label: 'K√ºche', name: 'common_kitchen', remarks: 'common_kitchen_remarks' },
                    { label: 'Badezimmer', name: 'common_bathroom', remarks: 'common_bathroom_remarks' },
                    { label: 'Flur', name: 'common_hallway', remarks: 'common_hallway_remarks' }
                ];
                
                for (const item of commonItems) {
                    checkAddPage(15);
                    doc.text(`‚Ä¢ ${item.label}: ${getRadioValue(item.name)}`, margin + 2, yPosition);
                    yPosition += 5;
                    const remarks = getFormValue(item.remarks);
                    if (remarks) {
                        doc.setFontSize(9);
                        doc.setTextColor(80, 80, 80);
                        const lines = doc.splitTextToSize(`  Bemerkung: ${remarks}`, contentWidth - 5);
                        doc.text(lines, margin + 2, yPosition);
                        yPosition += lines.length * 4;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    if (formData.photos[item.name] && formData.photos[item.name].length > 0) {
                        yPosition += 2;
                        for (const photoData of formData.photos[item.name]) {
                            checkAddPage(60);
                            try {
                                doc.addImage(photoData, 'JPEG', margin + 2, yPosition, 50, 50);
                                yPosition += 52;
                            } catch (e) {
                                console.error('Error adding image:', e);
                            }
                        }
                    }
                    yPosition += 3;
                }
                
                yPosition += 5;
                
                // Section: Schl√ºssel
                checkAddPage(20);
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('Schl√ºssel', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const keysDetails = getFormValue('keys_details');
                if (keysDetails) {
                    const lines = doc.splitTextToSize(keysDetails, contentWidth);
                    doc.text(lines, margin + 2, yPosition);
                    yPosition += lines.length * 5;
                }
                
                if (formData.photos['keys'] && formData.photos['keys'].length > 0) {
                    yPosition += 2;
                    for (const photoData of formData.photos['keys']) {
                        checkAddPage(60);
                        try {
                            doc.addImage(photoData, 'JPEG', margin + 2, yPosition, 50, 50);
                            yPosition += 52;
                        } catch (e) {
                            console.error('Error adding image:', e);
                        }
                    }
                }
                
                yPosition += 5;
                
                // Section: Z√§hlerst√§nde
                checkAddPage(20);
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('Z√§hlerst√§nde', margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const meterElectricity = getFormValue('meter_electricity');
                if (meterElectricity) {
                    doc.text(`Strom: ${meterElectricity}`, margin + 2, yPosition);
                    yPosition += 5;
                }
                
                if (formData.photos['meter_electricity'] && formData.photos['meter_electricity'].length > 0) {
                    yPosition += 2;
                    for (const photoData of formData.photos['meter_electricity']) {
                        checkAddPage(60);
                        try {
                            doc.addImage(photoData, 'JPEG', margin + 2, yPosition, 50, 50);
                            yPosition += 52;
                        } catch (e) {
                            console.error('Error adding image:', e);
                        }
                    }
                }
                
                yPosition += 5;
                
                const meterWater = getFormValue('meter_water');
                if (meterWater) {
                    checkAddPage(10);
                    doc.text(`Wasser: ${meterWater}`, margin + 2, yPosition);
                    yPosition += 5;
                }
                
                if (formData.photos['meter_water'] && formData.photos['meter_water'].length > 0) {
                    yPosition += 2;
                    for (const photoData of formData.photos['meter_water']) {
                        checkAddPage(60);
                        try {
                            doc.addImage(photoData, 'JPEG', margin + 2, yPosition, 50, 50);
                            yPosition += 52;
                        } catch (e) {
                            console.error('Error adding image:', e);
                        }
                    }
                }
                
                yPosition += 10;
                
                // Section: Unterschriften
                checkAddPage(80);
                doc.setFontSize(14);
                doc.setTextColor(139, 0, 0);
                doc.text('Unterschriften', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                // Outgoing tenant signature
                doc.text('Ausziehender Mieter:', margin, yPosition);
                yPosition += 5;
                doc.text(getFormValue('name_outgoing'), margin, yPosition);
                yPosition += 5;
                
                const sigOutgoingData = sigOutgoing.toDataURL('image/png');
                doc.addImage(sigOutgoingData, 'PNG', margin, yPosition, 60, 20);
                yPosition += 25;
                
                // Incoming tenant signature
                doc.text('Einziehender Mieter:', margin, yPosition);
                yPosition += 5;
                doc.text(getFormValue('name_incoming'), margin, yPosition);
                yPosition += 5;
                
                const sigIncomingData = sigIncoming.toDataURL('image/png');
                doc.addImage(sigIncomingData, 'PNG', margin, yPosition, 60, 20);
                yPosition += 25;
                
                // Date
                doc.text(`Datum: ${getFormValue('handover_date')}`, margin, yPosition);
                
                // Save PDF
                const filename = `Uebergabeprotokoll_${getFormValue('property_address').replace(/[^a-zA-Z0-9]/g, '_')}_${getFormValue('handover_date')}.pdf`;
                doc.save(filename);
                
                // E-Mail-Versand aktiviert? (wenn URL gesetzt ist)
                if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL !== 'HIER_DEINE_WEB_APP_URL_EINFUEGEN') {
                    // Update progress
                    progress.innerHTML = 'üìß E-Mails werden versendet... Bitte warten...';
                    
                    // Prepare form data for email
                    const emailFormData = {
                        property_address: getFormValue('property_address'),
                        property_type: getRadioValue('property_type'),
                        room_number: getFormValue('room_number'),
                        name_outgoing: getFormValue('name_outgoing'),
                        email_outgoing: getFormValue('email_outgoing'),
                        name_incoming: getFormValue('name_incoming'),
                        email_incoming: getFormValue('email_incoming'),
                        email_landlord: getFormValue('email_landlord'),
                        handover_date: getFormValue('handover_date'),
                        pdfFilename: filename
                    };
                    
                    try {
                        // Send via Google Apps Script
                        await sendEmailViaGoogleScript(doc, emailFormData);
                        
                        // Show success message with email confirmation
                        progress.style.display = 'none';
                        success.style.display = 'block';
                        
                        const emails = [
                            getFormValue('email_outgoing'),
                            getFormValue('email_incoming'),
                            getFormValue('email_landlord')
                        ].filter(e => e).join(', ');
                        
                        success.innerHTML = `
                            ‚úÖ PDF erfolgreich erstellt und per E-Mail versendet!<br>
                            <strong>E-Mails wurden gesendet an:</strong><br>
                            <span style="font-size: 14px;">${emails}</span><br><br>
                            <small style="color: #666;">Das PDF wurde auch auf Ihren Computer heruntergeladen.</small>
                        `;
                    } catch (emailError) {
                        console.error('E-Mail-Versand-Fehler:', emailError);
                        // Show partial success message
                        progress.style.display = 'none';
                        success.style.display = 'block';
                        
                        const emails = [
                            getFormValue('email_outgoing'),
                            getFormValue('email_incoming'),
                            getFormValue('email_landlord')
                        ].filter(e => e).join(', ');
                        
                        success.innerHTML = `
                            ‚úÖ PDF erfolgreich erstellt und heruntergeladen!<br>
                            ‚ö†Ô∏è <strong>E-Mail-Versand fehlgeschlagen.</strong><br>
                            <small>Bitte senden Sie das PDF manuell an: ${emails}</small>
                        `;
                    }
                } else {
                    // No email configured - show manual instruction
                    progress.style.display = 'none';
                    success.style.display = 'block';
                    
                    const emails = [
                        getFormValue('email_outgoing'),
                        getFormValue('email_incoming'),
                        getFormValue('email_landlord')
                    ].filter(e => e).join(', ');
                    
                    document.getElementById('emailList').textContent = emails;
                }
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Fehler beim Erstellen des PDFs: ' + error.message);
                progress.style.display = 'none';
            }
            
            btn.disabled = false;
        }
        
        /**
         * Send email via Google Apps Script
         * Diese Funktion sendet das PDF automatisch per E-Mail
         */
        async function sendEmailViaGoogleScript(pdfDoc, formDataObj) {
            try {
                console.log('Preparing PDF for email transmission...');
                
                // Konvertiere PDF zu base64 (ohne data URI prefix)
                const pdfBase64 = pdfDoc.output('dataurlstring');
                
                // Extrahiere nur den Base64-Teil (nach dem Komma)
                const base64Data = pdfBase64.split(',')[1];
                
                // Log f√ºr Debugging
                console.log('PDF size (base64):', Math.round(base64Data.length / 1024), 'KB');
                console.log('Estimated PDF size:', Math.round(base64Data.length * 0.75 / 1024), 'KB');
                
                // Warnung bei gro√üen Dateien
                if (base64Data.length * 0.75 > 25 * 1024 * 1024) {
                    console.warn('WARNING: PDF is larger than 25MB! Gmail may reject it.');
                    alert('Warnung: Das PDF ist sehr gro√ü (>25MB). E-Mail-Versand k√∂nnte fehlschlagen. Bitte weniger Fotos verwenden.');
                }
                
                // Bereite Daten f√ºr Google Script vor
                const payload = {
                    language: 'de',
                    property_address: formDataObj.property_address,
                    property_type: formDataObj.property_type,
                    room_number: formDataObj.room_number || '',
                    name_outgoing: formDataObj.name_outgoing,
                    email_outgoing: formDataObj.email_outgoing,
                    name_incoming: formDataObj.name_incoming,
                    email_incoming: formDataObj.email_incoming,
                    email_landlord: formDataObj.email_landlord,
                    handover_date: formDataObj.handover_date,
                    pdfBase64: base64Data, // Nur Base64, kein data URL prefix
                    pdfFilename: formDataObj.pdfFilename
                };
                
                console.log('Sending to Google Apps Script...');
                console.log('Payload size:', Math.round(JSON.stringify(payload).length / 1024), 'KB');
                
                // Sende an Google Apps Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });
                
                // Pr√ºfe Response
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                // Versuche Response zu lesen (funktioniert nur bei CORS-erlaubten Domains)
                try {
                    const result = await response.text();
                    console.log('Server response:', result);
                } catch (e) {
                    // Ignoriere - no-cors mode verhindert Response-Lesen
                    console.log('Response received (no-cors mode, cannot read details)');
                }
                
                console.log('Email sent successfully!');
                return { success: true };
                
            } catch (error) {
                console.error('Fehler beim E-Mail-Versand:', error);
                throw error;
            }
        }
        
        // Auto-save to localStorage
        document.addEventListener('input', function(e) {
            if (e.target.id) {
                localStorage.setItem(e.target.id, e.target.value);
            }
        });
        
        // Load from localStorage
        window.addEventListener('load', function() {
            document.querySelectorAll('input[type="text"], input[type="email"], input[type="date"], textarea').forEach(element => {
                const saved = localStorage.getItem(element.id);
                if (saved && element.id !== 'email_landlord') {
                    element.value = saved;
                }
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                const saved = localStorage.getItem(radio.name);
                if (saved === radio.value) {
                    radio.checked = true;
                    radio.parentElement.classList.add('checked');
                    if (radio.name === 'property_type' && radio.value === 'Zimmer') {
                        toggleRoomNumber(true);
                    }
                }
            });
        });
    </script>
</body>
</html>
